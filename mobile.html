<!DOCTYPE html>
<html ng-app="ionicApp">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no, width=device-width">
    <title>Flea Market by PuTTYshell</title>
    <link href="./stylesheets/ionic.min.css" rel="stylesheet">
    <link href="./stylesheets/style.css" rel="stylesheet">
    <script src="./javascripts/ionic.bundle.min.js" type="text/javascript"></script>
    <script src="./javascripts/lunr.js" type="application/javascript"></script>
    <script src="./javascripts/script.js" type="text/javascript" charset="utf-8"></script>
</head>

<body ng-controller="AppCtrl">

<style>
    * {
        box-sizing: border-box;
    }

    a.item-content {
        padding: 5px 10px !important;
    }
</style>
<script>
    var fm = angular.module('ionicApp', ['ionic']);
    fm.controller('AppCtrl', function ($scope, $http, $q, $sce, $ionicModal) {
        function trim(str) {
            if (!str) {
                return str;
            }
            return str.replace(/^\s\s*/, '').replace(/\s\s*$/, '');
        }

        function action(txt) {
            if (/(出|售|卖)/.test(txt)) {
                return "售";
            }
            if (/(求|购|收|买)/.test(txt)) {
                return "购";
            }
            return ""
        }

        function price(txt) {
            var rst = /(?:at|@)+[ \$]*([.0-9]+)/.exec(txt);
            if (rst && rst[1]) {
                return '' + Number(rst[1]);
            }
            rst = /(?:at|@|\$)+ *([.0-9]+)/.exec(txt);
            if (rst && rst[1]) {
                return '' + Number(rst[1]);
            }
            return "";
        }

        function sortByNumber(a, b) {
            var nA = Number(a || 999999999);
            var nB = Number(b || 999999999);
            if (nA == nB) {
                return 0;
            }
            return nA > nB ? 1 : -1;
        }

        var seqIndex = 0;
        $scope.ads = {};
        var cnt = 17;

        function refresh() {
            $http.
                    get("http://query.yahooapis.com/v1/public/yql?q=select%20*%20from%20html%20where%20url%3D%22http%3A%2F%2Fwww.mitbbs.com%2Fbbsdoc1%2FfleaMarket_" + cnt + "_0.html%22%20and%20xpath%3D%22%2F%2Ftd%5B%40class%3D'taolun_leftright'%5D%2Ftable%2Ftr%22&format=json&diagnostics=true&env=store%3A%2F%2Fdatatables.org%2Falltableswithkeys&callback=").
                    then(function (res) {
                        res.data.query.results.tr.
                                forEach(function (tr) {
                                    var td = tr.td;
                                    if (!td[0] || !td[0].p || !/[0-9]+/.test(td[0].p)) {
                                        return;
                                    }
                                    var cnt = td[2].strong.a.content;
                                    var id = "" + (++seqIndex);
                                    var d = {
                                        "id": id,
                                        "action": (action(cnt)),
                                        "price": (price(cnt)),
                                        "text": (cnt),
                                        "detailLink": td[2].strong.a.href,
                                        "author": (td[4].a && td[4].a.content),
                                        "pubTm": (td[4].span && td[4].span.content),
                                        "replyTm": (td[5].span && td[5].span.content)
                                    };
                                    //index.add(d);
                                    $scope.ads[d.detailLink] = d;
                                });
                        $scope.$apply();
                    });
        }
        refresh();

        var index = lunr(function () {
            //this.field('title', {boost: 10})
            this.field('text');
            this.ref('id');
        });

        $ionicModal.fromTemplateUrl('modal.html', function (modal) {
            $scope.modal = modal;
        }, {
            animation: 'slide-in-right',
            focusFirstInput: true
        });

        $scope.refresh = function (a) {
            $scope.doRefresh = function () {
                $http.get('/new-items').success(function (newItems) {
                    $scope.items = newItems;
                    //Stop the ion-refresher from spinning
                    $scope.$broadcast('scroll.refreshComplete');
                });
            };
        }
    });
    fm.controller('ModalCtrl', function ($scope) {
        $scope.newUser = {};
        $scope.createContact = function () {
            console.log('Create Contact', $scope.newUser);
            $scope.modal.hide();
        };
    });
</script>

<ion-header-bar class="bar-positive">
    <h1 class="title">MIT bbs Flea Market <span style="float: right; font: 8pt Arial;">by PuTTYshell</span></h1>

    <div class="buttons">
        <button class="button button-icon ion-compose"
                ng-click="modal.show()">
        </button>
    </div>
</ion-header-bar>

<ion-content>
    <ion-refresher
            pulling-text="Pull to refresh..."
            on-refresh="refresh()">
    </ion-refresher>
    <ion-list>
        <ion-item
                ng-repeat="(k,ad) in ads"
                style="padding: 0; margin: 0;">
            <div style="
                    min-width: 70px; min-height: 30px;
                    margin: 0 10px 0 0;
                    float: left;
                    border: 1px solid #bfbef3;
                    border-radius: 3px;
                    padding: 5px;">
                <span style="font:bold 15px Arial; margin: auto;">{{ad.action}}</span>
                <span style="float: right; color: darkred;">{{ad.price}}</span>
            </div>
            <div style="
                    width: 5px; height: 30px;
                    margin: 2px;
                    float: right;
                    padding: 5px;">
                >
            </div>
            <div>
                <div colspan="10">{{ad.text}}</div>
                <div style="float:left; font: 9pt Arial; color: grey;">{{ad.author}}, {{ad.pubTm}}</div>
            </div>
        </ion-item>
    </ion-list>
</ion-content>

<script id="modal.html" type="text/ng-template">
    <div class="modal" ng-controller="ModalCtrl">
        <ion-header-bar class="bar bar-header bar-positive">
            <h1 class="title">New Contact</h1>
            <button class="button button-clear button-primary" ng-click="modal.hide()">Cancel</button>
        </ion-header-bar>
        <ion-content>
            <div class="padding">
                <div class="list">
                    <label class="item item-input">
                        <span class="input-label">First Name</span>
                        <input ng-model="newUser.firstName" type="text">
                    </label>
                    <label class="item item-input">
                        <span class="input-label">Last Name</span>
                        <input ng-model="newUser.lastName" type="text">
                    </label>
                    <label class="item item-input">
                        <span class="input-label">Email</span>
                        <input ng-model="newUser.email" type="text">
                    </label>
                    <button class="button button-full button-positive"
                            ng-click="createContact()">Create
                    </button>
                </div>
            </div>
        </ion-content>
    </div>
</script>

</body>
</html>
