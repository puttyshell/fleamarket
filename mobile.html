<!DOCTYPE html>
<html ng-app="ionicApp">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no, width=device-width">
    <title>Flea Market by PuTTYshell</title>
    <link href="./stylesheets/ionic.min.css" rel="stylesheet">
    <link href="./stylesheets/style.css" rel="stylesheet">
    <script src="./javascripts/ionic.bundle.min.js" type="text/javascript"></script>
    <script src="./javascripts/lunr.js" type="application/javascript"></script>
    <script src="./javascripts/script.js" type="text/javascript" charset="utf-8"></script>
</head>

<body ng-controller="AppCtrl">

<style>
    * {
        box-sizing: border-box;
    }

    a.item-content {
        padding: 5px 10px !important;
        height: 70px !important;
    }
</style>
<script>
    var fm = angular.module('ionicApp', ['ionic']);
    fm.controller('AppCtrl', function ($scope, $http, $q, $sce, $ionicModal, $timeout, $ionicLoading) {
        function trim(str) {
            if (!str) {
                return str;
            }
            return str.replace(/^\s\s*/, '').replace(/\s\s*$/, '');
        }

        function action(txt) {
            if (/(出|售|卖)/.test(txt)) {
                return "售";
            }
            if (/(求|购|收|买)/.test(txt)) {
                return "购";
            }
            return ""
        }

        function price(txt) {
            var rst = /(?:at|@)+[ \$]*([.0-9]+)/.exec(txt);
            var price = 0;
            if (rst && rst[1]) {
                price = Number(rst[1]);
            } else {
                rst = /(?:at|@|\$)+ *([.0-9]+)/.exec(txt);
                if (rst && rst[1]) {
                    price = Number(rst[1]).toFixed(2);
                }
            }
            if (!price) {
                return {};
            }

            var dollar = '' + Math.floor(price);
            var cent = '00' + Math.floor(price * 100 - Math.floor(price) * 100);
            cent = cent.substr(cent.length - 2);
            return {
                value: price,
                dollar: dollar,
                cent: Number(cent) > 0 ? "." + cent : ""
            };
        }

        function sortByNumber(a, b) {
            var nA = Number(a || 999999999);
            var nB = Number(b || 999999999);
            if (nA == nB) {
                return 0;
            }
            return nA > nB ? 1 : -1;
        }

        var seqIndex = 0;
        $scope.ads = {};
        $scope.adsAry = [];
        $scope.displayData = [];

        var loading = $ionicLoading.show({
            content: 'Loading ...'
        });

        function refresh(total) {
            var ttl = total || 200;
            var req = [];
            for (var cnt = 20; cnt < ttl; cnt += 100) {
                req.push($http.get("http://query.yahooapis.com/v1/public/yql?q=select%20*%20from%20html%20where%20url%3D%22http%3A%2F%2Fwww.mitbbs.com%2Fbbsdoc1%2FfleaMarket_" + cnt + "_0.html%22%20and%20xpath%3D%22%2F%2Ftd%5B%40class%3D'taolun_leftright'%5D%2Ftable%2Ftr%22&format=json&diagnostics=true&env=store%3A%2F%2Fdatatables.org%2Falltableswithkeys&callback="));
            }
            $q.
                    all(req).
                    then(function (result) {
                        var rstArr = [];
                        result.forEach(function (res) {
                            res.data.query.results.tr.
                                    forEach(function (tr) {
                                        var td = tr.td;
                                        if (!td[0] || !td[0].p || !/[0-9]+/.test(td[0].p)) {
                                            return;
                                        }
                                        var cnt = td[2].strong.a.content;
                                        var id = "" + (++seqIndex);
                                        cnt = cnt.substr(2);
                                        var d = {
                                            "id": id,
                                            "action": (action(cnt)),
                                            "price": (price(cnt)),
                                            "text": (cnt),
                                            "detailLink": td[2].strong.a.href,
                                            "author": (td[4].a && td[4].a.content),
                                            "pubTm": (td[4].span && td[4].span.content),
                                            "replyTm": (td[5].span && td[5].span.content)
                                        };
                                        index.add(d);
                                        if (!$scope.ads[d.detailLink]) {
                                            rstArr.push(d);
                                        }
                                        $scope.ads[d.detailLink] = d;
                                    });
                        });
                        loading.hide();
                        $scope.$broadcast('scroll.refreshComplete');
                        $scope.adsAry = rstArr.concat($scope.adsAry);
                        $scope.displayData = $scope.adsAry;
                    });
        }

        function search() {
            var results = null;
            if ($scope.query) {
                var searching = $ionicLoading.show({
                    content: 'Searching ...'
                });
                $timeout(function () {
                    results = index.search($scope.query);
                    $scope.displayData = [];
                    results.forEach(function (k) {
                        $scope.displayData.push($scope.ads[k.ref]);
                    });
                    if ($scope.displayData.length == 0) {
                        $scope.displayData = [
                            {
                                text: "No deal meets the search criteria."
                            }
                        ];
                    }
                    $scope.$broadcast('scroll.scrollTop');
                    searching.hide();
                });
                return;
            }
            $scope.displayData = $scope.adsAry;
        }

        var invoke, done;
        $scope.search = function () {
            invoke = search;
            done && $timeout.cancel(done);
            done = $timeout(function () {
                invoke && invoke();
                invoke = null;
            }, 1000);
        };

        var index = lunr(function () {
            //this.field('title', {boost: 10})
            this.field('text');
            this.field('action');
            this.field('author');
            this.ref('detailLink');
        });
        refresh(500);

        $ionicModal.fromTemplateUrl('modal.html', function (modal) {
            $scope.modal = modal;
        }, {
            animation: 'slide-in-right',
            focusFirstInput: true
        });

        $scope.refresh = refresh;
    });
    fm.controller('ModalCtrl', function ($scope, $sce) {
        $scope.getLink = function () {
            if (!$scope.modal || !$scope.modal.ad || !$scope.modal.ad.detailLink) {
                return $sce.trustAsResourceUrl('http://www.mitbbs.com');
            }
            return $sce.trustAsResourceUrl('http://www.mitbbs.com' + $scope.modal.ad.detailLink);
        };

        $scope.goBack = function () {
            $scope.modal.hide();
        };
    });
    (function (i, s, o, g, r, a, m) {
        i['GoogleAnalyticsObject'] = r;
        i[r] = i[r] || function () {
            (i[r].q = i[r].q || []).push(arguments)
        }, i[r].l = 1 * new Date();
        a = s.createElement(o),
                m = s.getElementsByTagName(o)[0];
        a.async = 1;
        a.src = g;
        m.parentNode.insertBefore(a, m)
    })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');
    ga('create', 'UA-49699999-1', 'puttyshell.github.io');
    ga('send', 'pageview');
</script>

<ion-header-bar class="bar-positive" style="width: 100%;">
    <div>
        <input type="search"
               ng-change="search()"
               ng-model="query"
               placeholder="flea market search ..."
               style="border-radius: 10px; height: 30px; padding:0 10px;">
    </div>
    <div style="float: right; width: 100%; font: 8pt Arial;">..... by PuTTYshell</div>
</ion-header-bar>

<ion-content>
    <ion-refresher
            pulling-text="Pull to refresh..."
            on-refresh="refresh()">
    </ion-refresher>
    <ion-list>
        <ion-item
                ng-repeat="ad in displayData track by $index"
                style="padding: 0; margin: 0; position: relative;"
                ng-click="modal.ad = ad; modal.show()">
            <div style="
                    min-width: 40px; min-height: 50px;
                    margin: 0 10px 0 0;
                    float: left;
                    border: 1px solid #bfbef3;
                    border-radius: 3px;
                    text-align: center;
                    padding: 5px;">
                <div style="font:bold 15px Arial; margin: auto;">{{ad.action}}</div>
                <span style="color: darkred;">{{ad.price.dollar}}<span
                        mg-show="ad.price.cent"
                        style="vertical-align: super; font: 8pt Arial;"
                        >{{ad.price.cent}}</span></span>
            </div>
            <div style="position: absolute;
                left: 60px; right: 30px;
                text-overflow: ellipsis;
                white-space:normal;
                word-break: break-all;
                float: left;
                overflow:visible;">
                {{ad.text}}

                <span style="float:right;font: 9pt Arial; color: grey; white-space: nowrap;"><span>{{ad.author}}</span>, {{ad.replyTm}},
                    ({{ad.pubTm}})
                </span>
            </div>
        </ion-item>
    </ion-list>
</ion-content>

<script id="modal.html" type="text/ng-template">
    <div class="modal" ng-controller="ModalCtrl">
        <ion-header-bar class="bar bar-header bar-positive">
            <h1 class="title">FleaMarket</h1>
            <button class="button button-clear button-primary"
                    ng-click="modal.hide()">Back
            </button>
        </ion-header-bar>
        <ion-content>
            <a class="btn btn-mini"
               href="http://www.mitbbs.com/{{modal.ad.detailLink}}"
               target="_blank">mitbbs</a>
            <iframe style="width: 100%; height: 800px;"
                    ng-src="{{getLink()}}">
            </iframe>
        </ion-content>
    </div>
</script>

</body>
</html>
