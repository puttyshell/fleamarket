<!DOCTYPE html>
<html ng-app="ionicApp">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no, width=device-width">
    <title>Flea Market by PuTTYshell</title>
    <link href="./stylesheets/ionic.min.css" rel="stylesheet">
    <link href="./stylesheets/style.css" rel="stylesheet">
    <script src="./javascripts/ionic.bundle.min.js" type="text/javascript"></script>
    <script src="./javascripts/lunr.js" type="application/javascript"></script>
    <script src="./javascripts/script.js" type="text/javascript" charset="utf-8"></script>
</head>

<body ng-controller="AppCtrl">

<style>
    * {
        box-sizing: border-box;
    }

    a.item-content {
        padding: 5px 10px !important;
    }
</style>
<script>
    var fm = angular.module('ionicApp', ['ionic']);
    fm.controller('AppCtrl', function ($scope, $http, $q, $sce, $ionicModal) {
        function trim(str) {
            if (!str) {
                return str;
            }
            return str.replace(/^\s\s*/, '').replace(/\s\s*$/, '');
        }

        function action(txt) {
            if (/(出|售|卖)/.test(txt)) {
                return "售";
            }
            if (/(求|购|收|买)/.test(txt)) {
                return "购";
            }
            return ""
        }

        function price(txt) {
            var rst = /(?:at|@)+[ \$]*([.0-9]+)/.exec(txt);
            if (rst && rst[1]) {
                return '' + Number(rst[1]);
            }
            rst = /(?:at|@|\$)+ *([.0-9]+)/.exec(txt);
            if (rst && rst[1]) {
                return '' + Number(rst[1]);
            }
            return "";
        }

        function sortByNumber(a, b) {
            var nA = Number(a || 999999999);
            var nB = Number(b || 999999999);
            if (nA == nB) {
                return 0;
            }
            return nA > nB ? 1 : -1;
        }

        var seqIndex = 0;
        $scope.ads = {};

        function refresh(total) {
            var ttl = total || 100;
            for (var cnt = 15; cnt < ttl; cnt += 100) {
                $http.
                        get("http://query.yahooapis.com/v1/public/yql?q=select%20*%20from%20html%20where%20url%3D%22http%3A%2F%2Fwww.mitbbs.com%2Fbbsdoc1%2FfleaMarket_" + cnt + "_0.html%22%20and%20xpath%3D%22%2F%2Ftd%5B%40class%3D'taolun_leftright'%5D%2Ftable%2Ftr%22&format=json&diagnostics=true&env=store%3A%2F%2Fdatatables.org%2Falltableswithkeys&callback=").
                        then(function (res) {
                            res.data.query.results.tr.
                                    forEach(function (tr) {
                                        var td = tr.td;
                                        if (!td[0] || !td[0].p || !/[0-9]+/.test(td[0].p)) {
                                            return;
                                        }
                                        var cnt = td[2].strong.a.content;
                                        var id = "" + (++seqIndex);
                                        var d = {
                                            "id": id,
                                            "action": (action(cnt)),
                                            "price": (price(cnt)),
                                            "text": (cnt),
                                            "detailLink": td[2].strong.a.href,
                                            "author": (td[4].a && td[4].a.content),
                                            "pubTm": (td[4].span && td[4].span.content),
                                            "replyTm": (td[5].span && td[5].span.content)
                                        };
                                        index.add(d);
                                        $scope.ads[d.detailLink] = d;
                                    });
                            $scope.$broadcast('scroll.refreshComplete');
                        });
            }
        }

        refresh(1000);

        var index = lunr(function () {
            //this.field('title', {boost: 10})
            this.field('text');
            this.ref('id');
        });

        $ionicModal.fromTemplateUrl('modal.html', function (modal) {
            $scope.modal = modal;
        }, {
            animation: 'slide-in-right',
            focusFirstInput: true
        });

        $scope.refresh = refresh;
    });
    fm.controller('ModalCtrl', function ($scope) {
        $scope.newUser = {};
        $scope.createContact = function () {
            console.log('Create Contact', $scope.newUser);
            $scope.modal.hide();
        };
    });
    (function (i, s, o, g, r, a, m) {
        i['GoogleAnalyticsObject'] = r;
        i[r] = i[r] || function () {
            (i[r].q = i[r].q || []).push(arguments)
        }, i[r].l = 1 * new Date();
        a = s.createElement(o),
                m = s.getElementsByTagName(o)[0];
        a.async = 1;
        a.src = g;
        m.parentNode.insertBefore(a, m)
    })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');
    ga('create', 'UA-49699999-1', 'puttyshell.github.io');
    ga('send', 'pageview');
</script>

<ion-header-bar class="bar-positive">
    <h1 class="title">MIT bbs Flea Market <span style="float: right; font: 8pt Arial;">by PuTTYshell</span></h1>

</ion-header-bar>

<ion-content>
    <ion-refresher
            pulling-text="Pull to refresh..."
            on-refresh="refresh()">
    </ion-refresher>
    <ion-list>
        <ion-item
                ng-repeat="(k,ad) in ads"
                style="padding: 0; margin: 0;"
                ng-click="modal.show()">
            <div style="
                    min-width: 70px; min-height: 30px;
                    margin: 0 10px 0 0;
                    float: left;
                    border: 1px solid #bfbef3;
                    border-radius: 3px;
                    padding: 5px;">
                <span style="font:bold 15px Arial; margin: auto;">{{ad.action}}</span>
                <span style="float: right; color: darkred;">{{ad.price}}</span>
            </div>
            <div>
                <div colspan="10">{{ad.text}}</div>
                <div style="float:left; font: 9pt Arial; color: grey;"><span>{{ad.author}}</span>, {{ad.replyTm}},
                    {{ad.pubTm}}
                </div>
            </div>
        </ion-item>
    </ion-list>
</ion-content>

<script id="modal.html" type="text/ng-template">
    <div class="modal" ng-controller="ModalCtrl">
        <ion-header-bar class="bar bar-header bar-positive">
            <h1 class="title">New Contact</h1>
            <button class="button button-clear button-primary" ng-click="modal.hide()">Cancel</button>
        </ion-header-bar>
        <ion-content>
            <div>
                <a class="btn btn-mini"
                   href="http://www.mitbbs.com/{{mySelections[0].detailLink}}"
                   target="_blank">mitbbs</a>
                <button class="btn btn-mini"
                        style="float:right;"
                        ng-click="mySelections[0]={}"><span class="icon-help16"></span> 使用说明
                </button>
            </div>

            <div class="fitParent market-data-detail-content">
                <iframe class="fitParent" style="width: 100%; height: 100%;" ng-src="{{getLink()}}">
                </iframe>
            </div>
        </ion-content>
    </div>
</script>

</body>
</html>
